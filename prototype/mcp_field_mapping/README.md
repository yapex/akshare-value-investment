# MCP字段映射原型 - 交互式学习机制

## 🎯 核心目标

实现智能字段映射系统，让LLM Agent通过"猜测-失败-学习-重试"的交互机制，自动掌握跨市场财务数据查询的准确字段映射。

## 📁 文件结构

```
prototype/mcp_field_mapping/
├── README.md                    # 本文档 - 原型说明
├── simple_learning_demo.py      # 🌟 核心演示 - 交互式学习机制
└── quick_test.py               # 🧪 原型验证 - 字段推断逻辑测试
```

## 🚀 核心演示：simple_learning_demo.py

### 功能特性
- **SimpleMCPServer**: 模拟MCP服务器，维护字段映射和学习存储
- **SimpleLLMAgent**: 模拟LLM Agent，实现智能查询和学习流程
- **交互式学习**: 失败时自动分析可用字段并学习最佳映射
- **经验复用**: 第二次查询直接使用学习到的映射

### 演示场景
```bash
# 运行交互式学习演示
uv run python prototype/mcp_field_mapping/simple_learning_demo.py
```

**输出示例**:
```
🚀 交互式学习演示

📋 场景1: 首次查询腾讯净利润
🤖 LLM Agent: 查询 00700 的 ['净利润']
❌ 查询失败，开始学习...
   💡 选择: 净利润 -> HOLDER_PROFIT
   ✅ 学习成功: 净利润 -> HOLDER_PROFIT
🎉 学习成功! 成功获取 1 个字段

📋 场景2: 第二次查询（使用学习结果）
✅ 查询成功: 成功获取 1 个字段
```

## 🧪 原型验证：quick_test.py

### 验证结果 (100%通过)
```
🎯 总体通过率: 4/4 (100.0%)
📈 成功标准评估:
   推断准确率 ≥ 60%: ✅ 达标 (100.0%)
   端到端成功率 ≥ 80%: ✅ 达标 (100.0%)
```

### 验证维度
1. **跨市场映射**: A股、港股、美股字段推断
2. **置信度评估**: 平均置信度 > 0.8
3. **学习机制**: 置信度提升验证
4. **端到端流程**: 完整业务流程验证

## 💡 核心设计原则

### 1. 失败友好的交互机制
```
用户查询 → LLM猜测 → MCP验证
    ↓ 失败
    ↓ 返回指导信息（可用字段列表）
    ↓ LLM分析并学习最佳映射
    ↓ 重新查询
    ↓ 成功并存储经验
```

### 2. 智能字段匹配
```python
# 简化的匹配规则（示例）
def _smart_match(self, target: str, available_fields: list) -> str:
    if target == "净利润":
        for field in available_fields:
            if "PROFIT" in field:
                return field
    elif target == "营业收入":
        for field in available_fields:
            if "INCOME" in field:
                return field
    return None
```

### 3. 学习存储机制
```python
# 存储结构
{
    "00700": {          # 股票代码
        "净利润": "HOLDER_PROFIT",  # 目标字段 -> 实际字段
    },
    "09988": {
        "净利润": "HOLDER_PROFIT",
    }
}
```

## 🎉 原型验证结论

### ✅ 架构可行性
- **LLM字段推断**: 基于规则的基础版本可行
- **学习机制**: 概念验证通过，可以存储和复用经验
- **端到端流程**: 推断→验证→学习→查询流程清晰
- **Token优化**: 按需返回字段的设计合理

### 🚀 下一步建议
1. **集成真实LLM API**: 使用Claude API替代规则推断
2. **完善学习算法**: 提高匹配准确性和泛化能力
3. **实现MCP协议接口**: 完整的MCP服务器实现

## 📊 技术指标

| 指标 | 目标值 | 实际值 | 状态 |
|------|--------|--------|------|
| 推断准确率 | ≥ 60% | 100% | ✅ 达标 |
| 端到端成功率 | ≥ 80% | 100% | ✅ 达标 |
| 学习置信度提升 | ≥ 5% | 10% | ✅ 达标 |
| 交互响应时间 | < 2s | 即时 | ✅ 达标 |

---

**状态**: ✅ 原型验证成功
**推荐**: 🚀 继续投入完整开发
**下一里程碑**: 集成真实LLM API实现