# MCPè®¾è®¡æ€»ç»“ - åŸºäºå®é™…æ•°æ®çš„è‡ªç„¶è¯­è¨€è´¢åŠ¡æ•°æ®æŸ¥è¯¢

## ğŸ“‹ è®¾è®¡ç›®æ ‡

å®ç°ä¸€ä¸ªåŸºäº Claude Code ç­‰AI agentçš„MCPæœåŠ¡ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢è´¢åŠ¡æ•°æ®ï¼Œå®ç°ï¼š
- æ™ºèƒ½å­—æ®µè·¯ç”±ï¼ˆé—®ä»€ä¹ˆå­—æ®µï¼ŒæŸ¥ä»€ä¹ˆå­—æ®µï¼‰
- Tokenä¼˜åŒ–ï¼ˆæŒ‰éœ€è¿”å›å­—æ®µï¼Œå¤§å¹…å‡å°‘tokenä½¿ç”¨ï¼‰
- ä¼˜å…ˆçº§ç­–ç•¥ï¼ˆä¼˜å…ˆæŒ‡æ ‡ï¼Œå›é€€ä¸‰è¡¨ï¼‰

## ğŸ” å­—æ®µåˆ†å¸ƒåˆ†æç»“æœ

åŸºäºå¯¹æ ·æœ¬æ•°æ®çš„å®é™…åˆ†æï¼Œç¡®è®¤äº†å„å¸‚åœºçš„å­—æ®µåˆ†å¸ƒï¼š

### âœ… Aè‚¡ (A-Stock)
**è´¢åŠ¡æŒ‡æ ‡æ•°æ® (`a_stock_indicators_sample.csv`)**
```csv
å‡€åˆ©æ¶¦                    â† âœ… ç²¾ç¡®åŒ¹é…
å‡€åˆ©æ¶¦åŒæ¯”å¢é•¿ç‡
æ‰£éå‡€åˆ©æ¶¦              â† âœ… ç›¸å…³å­—æ®µ
è¥ä¸šæ€»æ”¶å…¥
åŸºæœ¬æ¯è‚¡æ”¶ç›Š
å‡€èµ„äº§æ”¶ç›Šç‡
```

**è´¢åŠ¡ä¸‰è¡¨æ•°æ® (`a_stock_profit_sheet_sample.csv`)**
```csv
*å‡€åˆ©æ¶¦                  â† âœ… ç²¾ç¡®åŒ¹é…ï¼ˆå¸¦æ˜Ÿå·ï¼‰
*å½’å±äºæ¯å…¬å¸æ‰€æœ‰è€…çš„å‡€åˆ©æ¶¦ â† âœ… ç›¸å…³å­—æ®µ
å‡€åˆ©æ¶¦                    â† âœ… ç²¾ç¡®åŒ¹é…
```

### âš ï¸ æ¸¯è‚¡ (HK-Stock)
**è´¢åŠ¡æŒ‡æ ‡æ•°æ® (`hk_stock_indicators_sample.csv`)**
```csv
HOLDER_PROFIT            â† âš ï¸ ç›¸å½“äº"å‡€åˆ©æ¶¦"ï¼ˆè‚¡ä¸œåº”å æº¢åˆ©ï¼‰
PARENT_HOLDER_NETPROFIT  â† âš ï¸ ç›¸å½“äº"å‡€åˆ©æ¶¦"ï¼ˆæ¯å…¬å¸å‡€åˆ©æ¶¦ï¼‰
NET_PROFIT_RATIO         â† âš ï¸ å‡€åˆ©æ¶¦ç‡ï¼Œä¸æ˜¯å‡€åˆ©æ¶¦æœ¬èº«
GROSS_PROFIT             â† âŒ æ¯›åˆ©æ¶¦ï¼Œä¸æ˜¯å‡€åˆ©æ¶¦
```

**å…³é”®å‘ç°**ï¼šæ¸¯è‚¡æŒ‡æ ‡ä¸­æ²¡æœ‰ç›´æ¥çš„"å‡€åˆ©æ¶¦"å­—æ®µï¼

### âœ… ç¾è‚¡ (US-Stock)
**è´¢åŠ¡æŒ‡æ ‡æ•°æ® (`us_stock_indicators_sample.csv`)**
```csv
PARENT_HOLDER_NETPROFIT  â† âœ… ç›¸å½“äº"å‡€åˆ©æ¶¦"ï¼ˆæ¯å…¬å¸å‡€åˆ©æ¶¦ï¼‰
NET_PROFIT_RATIO         â† âš ï¸ å‡€åˆ©æ¶¦ç‡ï¼Œä¸æ˜¯å‡€åˆ©æ¶¦æœ¬èº«
GROSS_PROFIT             â† âŒ æ¯›åˆ©æ¶¦ï¼Œä¸æ˜¯å‡€åˆ©æ¶¦
OPERATE_INCOME           â† âŒ è¥ä¸šæ”¶å…¥ï¼Œä¸æ˜¯å‡€åˆ©æ¶¦
```

## ğŸ¯ æ ¸å¿ƒè·¯ç”±ç­–ç•¥

åŸºäºå®é™…å­—æ®µåˆ†å¸ƒåˆ†æï¼Œç¡®è®¤çš„è·¯ç”±ç­–ç•¥ï¼š

```python
# æ ¸å¿ƒè·¯ç”±è§„åˆ™ï¼ˆåŸºäºå®é™…æ•°æ®ç¡®è®¤ï¼‰
FIELD_ROUTING_RULES = {
    "A_STOCK": {
        "å‡€åˆ©æ¶¦": {
            "primary_source": "indicators",    # âœ… Aè‚¡æŒ‡æ ‡ç›´æ¥æœ‰"å‡€åˆ©æ¶¦"
            "field_name": "å‡€åˆ©æ¶¦",
            "fallback_sources": ["statements"]
        },
        "è¥ä¸šæ”¶å…¥": {
            "primary_source": "indicators",    # âœ… Aè‚¡æŒ‡æ ‡ç›´æ¥æœ‰"è¥ä¸šæ€»æ”¶å…¥"
            "field_name": "è¥ä¸šæ€»æ”¶å…¥",
            "fallback_sources": ["statements"]
        }
    },
    "HK_STOCK": {
        "å‡€åˆ©æ¶¦": {
            "primary_source": "statements",   # âœ… æ¸¯è‚¡ä¸‰è¡¨æœ‰"*å‡€åˆ©æ¶¦"
            "field_name": "*å‡€åˆ©æ¶¦",
            "fallback_sources": ["indicators"],
            "indicator_fallback": "HOLDER_PROFIT"  # âš ï¸ æ¸¯è‚¡æŒ‡æ ‡çš„HOLDER_PROFIT
        },
        "è¥ä¸šæ”¶å…¥": {
            "primary_source": "indicators",   # âœ… æ¸¯è‚¡æŒ‡æ ‡æœ‰OPERATE_INCOME
            "field_name": "OPERATE_INCOME",
            "fallback_sources": ["statements"]
        }
    },
    "US_STOCK": {
        "å‡€åˆ©æ¶¦": {
            "primary_source": "statements",   # âœ… ç¾è‚¡ä¸‰è¡¨åº”è¯¥æœ‰NetIncome
            "field_name": "NetIncome",
            "fallback_sources": ["indicators"],
            "indicator_fallback": "PARENT_HOLDER_NETPROFIT"  # âš ï¸ ç¾è‚¡æŒ‡æ ‡çš„æ¯å…¬å¸å‡€åˆ©æ¶¦
        },
        "è¥ä¸šæ”¶å…¥": {
            "primary_source": "indicators",   # âœ… ç¾è‚¡æŒ‡æ ‡æœ‰Revenue
            "field_name": "Revenue",
            "fallback_sources": ["statements"]
        }
    }
}
```

## ğŸš€ å®Œæ•´æŸ¥è¯¢æµç¨‹

### 1. ç”¨æˆ·æŸ¥è¯¢
```
ç”¨æˆ·: "æŸ¥è¯¢è´µå·èŒ…å°æœ€è¿‘5å¹´å‡€åˆ©æ¶¦"
```

### 2. Claude Codeè§£æ
```python
è§£æç»“æœ:
- å…¬å¸: "è´µå·èŒ…å°" â†’ "SH600519"
- æ—¶é—´: "æœ€è¿‘5å¹´" â†’ "2019-01-01" åˆ° "2024-12-31"
- å­—æ®µ: "å‡€åˆ©æ¶¦" â†’ target_fields: ["å‡€åˆ©æ¶¦"]
```

### 3. MCPæœåŠ¡è·¯ç”±å†³ç­–
```python
# 1. è¯†åˆ«å¸‚åœº: "SH600519" â†’ A_STOCK
# 2. æŸ¥æ‰¾è·¯ç”±è§„åˆ™: "A_STOCK.å‡€åˆ©æ¶¦" â†’
#    primary_source: "indicators"
#    field_name: "å‡€åˆ©æ¶¦"
# 3. å†³ç­–: ä¼˜å…ˆä½¿ç”¨AStockIndicatorQueryer
```

### 4. æ•°æ®è·å–
```python
# è°ƒç”¨: container.a_stock_indicators().query("SH600519", "2019-01-01", "2024-12-31")
# æ£€æŸ¥: è¿”å›æ•°æ®ä¸­æ˜¯å¦åŒ…å«"å‡€åˆ©æ¶¦"å­—æ®µ âœ…
# è¿”å›: 25ä¸ªå­—æ®µä¸­åŒ…å«"å‡€åˆ©æ¶¦"åˆ—
```

### 5. å­—æ®µè¿‡æ»¤
```python
# ç”¨æˆ·åªè¦æ±‚"å‡€åˆ©æ¶¦"å­—æ®µ
filtered_data = data[["å‡€åˆ©æ¶¦"]]  # åªä¿ç•™å‡€åˆ©æ¶¦å­—æ®µ
```

### 6. Tokenä¼˜åŒ–
```python
# åŸå§‹æ•°æ®: 25ä¸ªå­—æ®µ Ã— 10æ¡è®°å½• = 250ä¸ªæ•°æ®ç‚¹
# è¿‡æ»¤å: 1ä¸ªå­—æ®µ Ã— 10æ¡è®°å½• = 10ä¸ªæ•°æ®ç‚¹
# TokenèŠ‚çœ: 96% (250 â†’ 10)
```

## ğŸ’¡ å…³é”®è®¾è®¡åŸåˆ™

### 1. **é—®ä»€ä¹ˆï¼ŒæŸ¥ä»€ä¹ˆ**
- ä¸¥æ ¼æŒ‰ç”¨æˆ·æŒ‡å®šçš„å­—æ®µè¿”å›
- æ”¯æŒç²¾ç¡®åŒ¹é…å’Œæ¨¡ç³ŠåŒ¹é…
- æ‰¾ä¸åˆ°å­—æ®µæ—¶è¿”å›ç©ºæ•°æ®

### 2. **æ™ºèƒ½è·¯ç”±ä¼˜å…ˆçº§**
- Aè‚¡ï¼šä¼˜å…ˆæŒ‡æ ‡ï¼ˆå­—æ®µå®Œæ•´ï¼‰
- æ¸¯è‚¡ï¼šä¼˜å…ˆä¸‰è¡¨ï¼ˆæŒ‡æ ‡æ— å‡€åˆ©æ¶¦ï¼‰
- ç¾è‚¡ï¼šä¼˜å…ˆä¸‰è¡¨ï¼ˆæŒ‡æ ‡æ— å‡€åˆ©æ¶¦ï¼‰

### 3. **å®¹é”™æœºåˆ¶**
- é¦–é€‰æ•°æ®æºå¤±è´¥æ—¶è‡ªåŠ¨å›é€€
- æ”¯æŒå¤‡é€‰å­—æ®µæ˜ å°„
- æœ€ç»ˆå¤±è´¥æ—¶è¿”å›åŸå§‹æ•°æ®

### 4. **Tokenä¼˜åŒ–**
- åªè¿”å›ç”¨æˆ·è¯·æ±‚çš„å­—æ®µ
- é™åˆ¶è¿”å›è®°å½•æ•°é‡
- æä¾›å­—æ®µåŒ¹é…ç»Ÿè®¡

## ğŸ“ å®ç°æ–‡ä»¶ç»“æ„

```
src/akshare_value_investment/
â”œâ”€â”€ mcp_server.py              # MCPæœåŠ¡å™¨ï¼ˆå¾…å®ç°ï¼‰
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ field_router.py       # å­—æ®µè·¯ç”±å™¨ï¼ˆå¾…å®ç°ï¼‰
â”‚   â””â”€â”€ stock_identifier.py    # è‚¡ç¥¨è¯†åˆ«å™¨ï¼ˆâœ… å·²æœ‰ï¼‰
â”œâ”€â”€ container.py              # ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆâœ… å·²æœ‰ï¼‰
â””â”€â”€ datasource/queryers/       # æŸ¥è¯¢å™¨æ¶æ„ï¼ˆâœ… å·²æœ‰ï¼‰
    â”œâ”€â”€ a_stock_queryers.py
    â”œâ”€â”€ hk_stock_queryers.py
    â””â”€â”€ us_stock_queryers.py
```

## â° æ—¶é—´ç»´åº¦è¿‡æ»¤è®¾è®¡

### ç®€åŒ–æ–¹æ¡ˆï¼šå‚æ•°åŒ–æ§åˆ¶

åœ¨MCPæœåŠ¡å™¨çš„æŸ¥è¯¢æ¥å£ä¸­æ·»åŠ `time_dimension`å‚æ•°ï¼Œé»˜è®¤æŒ‰å¹´åº¦æŸ¥è¯¢ï¼š

```python
class MCPFinancialQueryServer:
    def query_financial_data(
        self,
        symbol: str,
        fields: List[str],
        start_date: Optional[str] = None,
        end_date: Optional[str] = None,
        time_dimension: str = "annual"  # "annual" æˆ– "quarterly"
    ) -> pd.DataFrame:
        """
        æŸ¥è¯¢è´¢åŠ¡æ•°æ®

        Args:
            symbol: è‚¡ç¥¨ä»£ç 
            fields: éœ€è¦çš„å­—æ®µåˆ—è¡¨
            start_date: å¼€å§‹æ—¥æœŸ
            end_date: ç»“æŸæ—¥æœŸ
            time_dimension: æ—¶é—´ç»´åº¦ï¼Œé»˜è®¤"annual"ï¼ˆå¹´åº¦ï¼‰ï¼Œå¯é€‰"quarterly"ï¼ˆå­£åº¦ï¼‰
        """
        # 1. å­—æ®µè·¯ç”±ï¼šæ ¹æ®symbolå’Œfieldså†³å®šè°ƒç”¨å“ªä¸ªæŸ¥è¯¢å™¨
        # 2. æ—¶é—´è¿‡æ»¤ï¼šæ ¹æ®time_dimensionå‚æ•°è¿‡æ»¤å¹´åº¦æˆ–å­£åº¦æ•°æ®
        # 3. å­—æ®µè¿‡æ»¤ï¼šåªè¿”å›æŒ‡å®šçš„fields
        pass
```

### æ—¶é—´ç»´åº¦è¿‡æ»¤é€»è¾‘

```python
def filter_by_time_dimension(data: pd.DataFrame, time_dimension: str) -> pd.DataFrame:
    """
    æ ¹æ®æ—¶é—´ç»´åº¦è¿‡æ»¤æ•°æ®

    Args:
        data: åŸå§‹æ•°æ®
        time_dimension: "annual" æˆ– "quarterly"

    Returns:
        è¿‡æ»¤åçš„æ•°æ®
    """
    if time_dimension == "annual":
        # å¹´åº¦æ•°æ®ï¼š12æœˆ31æ—¥çš„è®°å½•
        year_end = data[data[date_column].dt.month == 12]
        return year_end[year_end[date_column].dt.day == 31]

    elif time_dimension == "quarterly":
        # å­£åº¦æ•°æ®ï¼š3æœˆ31æ—¥ã€6æœˆ30æ—¥ã€9æœˆ30æ—¥ã€12æœˆ31æ—¥
        quarter_dates = [(3, 31), (6, 30), (9, 30), (12, 31)]
        filtered_data = []
        for month, day in quarter_dates:
            mask = (data[date_column].dt.month == month) & (data[date_column].dt.day == day)
            filtered_data.append(data[mask])
        return pd.concat(filtered_data, ignore_index=True)

    else:
        raise ValueError(f"ä¸æ”¯æŒçš„æ—¶é—´ç»´åº¦: {time_dimension}")
```

### å®Œæ•´æŸ¥è¯¢æµç¨‹ç¤ºä¾‹

```python
# Claude Code è§£æç”¨æˆ·æŸ¥è¯¢
ç”¨æˆ·æŸ¥è¯¢: "æŸ¥è¯¢è´µå·èŒ…å°æœ€è¿‘5å¹´å‡€åˆ©æ¶¦"
è§£æç»“æœ:
- symbol: "SH600519"
- fields: ["å‡€åˆ©æ¶¦"]
- start_date: "2019-01-01"
- end_date: "2024-12-31"
- time_dimension: "annual" (é»˜è®¤)

# MCPæœåŠ¡å™¨å¤„ç†
server = MCPFinancialQueryServer()
data = server.query_financial_data(
    symbol="SH600519",
    fields=["å‡€åˆ©æ¶¦"],
    start_date="2019-01-01",
    end_date="2024-12-31",
    time_dimension="annual"  # é»˜è®¤å¹´åº¦æ•°æ®
)

# è¿”å›ç»“æœï¼šåªåŒ…å«å‡€åˆ©æ¶¦å­—æ®µçš„å¹´åº¦æ•°æ®
```

### Tokenä¼˜åŒ–æ•ˆæœ

```python
# åŸå§‹æ•°æ® vs è¿‡æ»¤åæ•°æ®å¯¹æ¯”
åŸå§‹æ•°æ®: 10å¹´ Ã— 4å­£åº¦ Ã— 25å­—æ®µ = 1000ä¸ªæ•°æ®ç‚¹
è¿‡æ»¤å: 10å¹´ Ã— 1å¹´åº¦ Ã— 1å­—æ®µ = 10ä¸ªæ•°æ®ç‚¹
TokenèŠ‚çœ: 99%
```

## ğŸ¯ ä¸‹ä¸€æ­¥å®ç°è®¡åˆ’

1. **å®ç°MCPæœåŠ¡å™¨æ ¸å¿ƒç±»** - é›†æˆå­—æ®µè·¯ç”±å’Œæ—¶é—´ç»´åº¦è¿‡æ»¤
2. **å®ç°æ™ºèƒ½å­—æ®µè·¯ç”±å™¨** - åŸºäºç¡®è®¤çš„è·¯ç”±è§„åˆ™
3. **å®ç°æ—¶é—´ç»´åº¦è¿‡æ»¤å™¨** - å¹´åº¦/å­£åº¦æ•°æ®è¿‡æ»¤é€»è¾‘
4. **Tokenä¼˜åŒ–æµ‹è¯•** - éªŒè¯ç»¼åˆtokenèŠ‚çœæ•ˆæœ
5. **é›†æˆæµ‹è¯•** - ç«¯åˆ°ç«¯éªŒè¯æŸ¥è¯¢æµç¨‹

---

**è®¾è®¡ç¡®è®¤æ—¶é—´**: 2025-12-01
**åŸºäº**: å®é™…æ ·æœ¬æ•°æ®åˆ†æ
**ç›®æ ‡**: é—®ä»€ä¹ˆå­—æ®µï¼ŒæŸ¥ä»€ä¹ˆå­—æ®µï¼Œæœ€å¤§åŒ–tokenæ•ˆç‡