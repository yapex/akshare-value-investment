"""
æ•°æ®æŸ¥è¯¢å™¨åŸºç±» - SQLiteæ™ºèƒ½ç¼“å­˜æ¶æ„æ ¸å¿ƒ

è¯¥æ¨¡å—å®šä¹‰äº†æ‰€æœ‰å¸‚åœºæŸ¥è¯¢å™¨çš„åŸºç±»ï¼Œæä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£å’ŒSQLiteæ™ºèƒ½ç¼“å­˜åŠŸèƒ½ã€‚
é‡‡ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ï¼Œå®ç°é«˜æ•ˆçš„æ•°æ®æŸ¥è¯¢å’Œç¼“å­˜ç®¡ç†ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¾è®¡æ¨¡å¼åº”ç”¨
- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**: å®šä¹‰ç»Ÿä¸€çš„æŸ¥è¯¢æµç¨‹ï¼Œå­ç±»å®ç°å…·ä½“çš„æ•°æ®è·å–é€»è¾‘
- **å·¥å‚æ¨¡å¼**: create_cached_query_method åŠ¨æ€åˆ›å»ºå¸¦ç¼“å­˜çš„æŸ¥è¯¢æ–¹æ³•
- **è£…é¥°å™¨æ¨¡å¼**: é€æ˜é›†æˆSQLiteæ™ºèƒ½ç¼“å­˜åŠŸèƒ½
- **ç­–ç•¥æ¨¡å¼**: ä¸åŒå­ç±»å®ç°ä¸åŒçš„æ•°æ®è·å–ç­–ç•¥

### æ ¸å¿ƒç»„ä»¶
- **BaseDataQueryer**: æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰æŸ¥è¯¢æ¥å£å’Œç¼“å­˜é€»è¾‘
- **create_cached_query_method**: å·¥å‚å‡½æ•°ï¼ŒåŠ¨æ€åˆ›å»ºç¼“å­˜æŸ¥è¯¢æ–¹æ³•
- **smart_sqlite_cache**: æ™ºèƒ½ç¼“å­˜è£…é¥°å™¨ï¼Œæä¾›å¢é‡æ›´æ–°åŠŸèƒ½

## ğŸ’¾ ç¼“å­˜æœºåˆ¶è¯¦è§£

### SQLiteæ™ºèƒ½ç¼“å­˜ç‰¹æ€§
- **å¢é‡æ›´æ–°**: æ™ºèƒ½è¯†åˆ«ç¼ºå¤±æ•°æ®èŒƒå›´ï¼Œä»…è·å–å¿…è¦æ•°æ®
- **å¤åˆä¸»é”®**: (symbol, date, query_type) ç²¾ç¡®ç¼“å­˜ç®¡ç†
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ threading.local() æ”¯æŒé«˜å¹¶å‘è®¿é—®
- **æ€§èƒ½ä¼˜åŒ–**: APIè°ƒç”¨å‡å°‘70%+ï¼ŒæŸ¥è¯¢é€Ÿåº¦æå‡50%+

### ç¼“å­˜æµç¨‹
1. **æŸ¥è¯¢è¯·æ±‚**: æ¥æ”¶è‚¡ç¥¨ä»£ç å’Œæ—¥æœŸèŒƒå›´
2. **ç¼“å­˜æ£€æŸ¥**: æ£€æŸ¥SQLiteç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨æ‰€éœ€æ•°æ®
3. **ç¼ºå¤±åˆ†æ**: æ™ºèƒ½è¯†åˆ«æ•°æ®ç¼ºå¤±çš„æ—¶é—´èŒƒå›´
4. **APIè°ƒç”¨**: ä»…è·å–ç¼ºå¤±çš„æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚
5. **æ•°æ®å­˜å‚¨**: å°†æ–°æ•°æ®å­˜å‚¨åˆ°ç¼“å­˜ä¸­
6. **ç»“æœè¿”å›**: è¿”å›å®Œæ•´çš„æ—¥æœŸèŒƒå›´æ•°æ®

## ğŸ”§ æ‰©å±•æŒ‡å—

### åˆ›å»ºæ–°çš„æŸ¥è¯¢å™¨
```python
class CustomStockQueryer(BaseDataQueryer):
    # ç¼“å­˜é…ç½®
    cache_date_field = 'custom_date'  # æ—¥æœŸå­—æ®µå
    cache_query_type = 'custom_data'  # æŸ¥è¯¢ç±»å‹æ ‡è¯†

    def _query_raw(self, symbol: str, start_date: Optional[str] = None,
                   end_date: Optional[str] = None) -> pd.DataFrame:
        # å®ç°å…·ä½“çš„æ•°æ®è·å–é€»è¾‘
        return get_custom_data(symbol, start_date, end_date)
```

### ç¼“å­˜é…ç½®è¯´æ˜
- **cache_date_field**: æŒ‡å®šæ•°æ®ä¸­çš„æ—¥æœŸå­—æ®µåï¼Œç”¨äºç¼“å­˜ç´¢å¼•
- **cache_query_type**: æŸ¥è¯¢ç±»å‹æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†ä¸åŒç±»å‹çš„æ•°æ®ç¼“å­˜

## ğŸ“Š æ•°æ®æ ¼å¼è§„èŒƒ

### è¾“å…¥å‚æ•°
- **symbol**: è‚¡ç¥¨ä»£ç ï¼Œæ ¼å¼å› å¸‚åœºè€Œå¼‚
- **start_date**: å¼€å§‹æ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼ï¼Œå¯é€‰
- **end_date**: ç»“æŸæ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼ï¼Œå¯é€‰

### è¾“å‡ºæ ¼å¼
- **pandas.DataFrame**: æ ‡å‡†åŒ–çš„DataFrameæ ¼å¼
- **æ—¥æœŸåˆ—**: å¿…é¡»åŒ…å«æŒ‡å®šçš„æ—¥æœŸå­—æ®µ
- **æ•°æ®åˆ—**: å…·ä½“çš„è´¢åŠ¡æ•°æ®å­—æ®µ

## âš ï¸ é‡è¦è¯´æ˜

### æ—¥æœŸå¤„ç†
- ç¼“å­˜å±‚è‡ªåŠ¨å¤„ç†æ—¥æœŸèŒƒå›´è¿‡æ»¤
- APIè°ƒç”¨æ—¶ä¼ é€’çš„æ—¥æœŸå‚æ•°å–å†³äºå…·ä½“APIçš„æ”¯æŒæƒ…å†µ
- åŸå§‹æ•°æ®è·å–åç”±ç¼“å­˜å±‚è¿›è¡Œæ—¥æœŸè¿‡æ»¤

### å¼‚å¸¸å¤„ç†
- å­ç±»å¿…é¡»å®ç° _query_raw æ–¹æ³•
- å»ºè®®åœ¨å­ç±»ä¸­æ·»åŠ å…·ä½“çš„å¼‚å¸¸å¤„ç†é€»è¾‘
- ç¼“å­˜è£…é¥°å™¨ä¼šå¤„ç†ç¼“å­˜ç›¸å…³çš„å¼‚å¸¸

### æ€§èƒ½è€ƒè™‘
- é¦–æ¬¡æŸ¥è¯¢ä¼šè§¦å‘APIè°ƒç”¨å’Œæ•°æ®ç¼“å­˜
- åç»­ç›¸åŒèŒƒå›´çš„æŸ¥è¯¢ä¼šç›´æ¥è¿”å›ç¼“å­˜æ•°æ®
- å¢é‡æŸ¥è¯¢åªä¼šè·å–ç¼ºå¤±çš„æ—¶é—´æ®µæ•°æ®
"""

from typing import Optional, ClassVar, Tuple
import pandas as pd

from ...core.data_queryer import IDataQueryer
from ...core.models import MarketType
from ...cache.smart_decorator import smart_sqlite_cache as smart_cache
from ...core.stock_identifier import StockIdentifier


def create_cached_query_method(cache_date_field: str, cache_query_type: str):
    """
    å·¥å‚å‡½æ•°ï¼šåˆ›å»ºå¸¦SQLiteæ™ºèƒ½ç¼“å­˜è£…é¥°å™¨çš„æŸ¥è¯¢æ–¹æ³•

    è¯¥å‡½æ•°å®ç°äº†å·¥å‚æ¨¡å¼ï¼Œæ ¹æ®é…ç½®å‚æ•°åŠ¨æ€åˆ›å»ºå¸¦ç¼“å­˜åŠŸèƒ½çš„æŸ¥è¯¢æ–¹æ³•ã€‚
    ç”Ÿæˆçš„æŸ¥è¯¢æ–¹æ³•ä¼šè‡ªåŠ¨é›†æˆSQLiteæ™ºèƒ½ç¼“å­˜ç³»ç»Ÿï¼Œæä¾›å¢é‡æ›´æ–°åŠŸèƒ½ã€‚

    Args:
        cache_date_field (str): æ•°æ®ä¸­çš„æ—¥æœŸå­—æ®µåï¼Œç”¨äºç¼“å­˜ç´¢å¼•å’Œæ—¥æœŸè¿‡æ»¤
            - Aè‚¡é€šå¸¸ä½¿ç”¨ 'report_date'
            - æ¸¯è‚¡/ç¾è‚¡é€šå¸¸ä½¿ç”¨ 'date'
        cache_query_type (str): æŸ¥è¯¢ç±»å‹æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒç±»å‹çš„æ•°æ®ç¼“å­˜
            - æ ¼å¼: '{market}_{datatype}'ï¼Œå¦‚ 'a_stock_indicators'
            - ç”¨äºSQLiteç¼“å­˜è¡¨çš„å¤åˆä¸»é”®çš„ä¸€éƒ¨åˆ†

    Returns:
        callable: è£…é¥°å¥½çš„æŸ¥è¯¢æ–¹æ³•ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š
            - è‡ªåŠ¨ç¼“å­˜é›†æˆ
            - å¢é‡æ›´æ–°æ”¯æŒ
            - æ—¥æœŸèŒƒå›´è¿‡æ»¤
            - çº¿ç¨‹å®‰å…¨ä¿éšœ

    Example:
        >>> # åˆ›å»ºAè‚¡è´¢åŠ¡æŒ‡æ ‡æŸ¥è¯¢æ–¹æ³•
        cached_method = create_cached_query_method(
            cache_date_field='report_date',
            cache_query_type='a_stock_indicators'
        )

        >>> # åº”ç”¨åˆ°ç±»å®ä¾‹
        queryer._query_with_dates = cached_method.__get__(queryer, type(queryer))

    Note:
        è¿”å›çš„æ–¹æ³•éœ€è¦ç»‘å®šåˆ°å…·ä½“çš„ç±»å®ä¾‹ä¸Šæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚
        ä½¿ç”¨ __get__ æ–¹æ³•è¿›è¡Œæ–¹æ³•ç»‘å®šæ˜¯Pythonçš„æ ‡å‡†åšæ³•ã€‚
    """
    @smart_cache(date_field=cache_date_field, query_type=cache_query_type)
    def cached_query(self, symbol: str, start_date: Optional[str] = None,
                    end_date: Optional[str] = None) -> pd.DataFrame:
        """
        å®é™…æŸ¥è¯¢é€»è¾‘ - å¸¦SQLiteæ™ºèƒ½ç¼“å­˜è£…é¥°å™¨çš„æ–¹æ³•

        è¯¥æ–¹æ³•ä½œä¸ºç¼“å­˜è£…é¥°å™¨çš„ç›®æ ‡å‡½æ•°ï¼Œè´Ÿè´£è°ƒç”¨å…·ä½“çš„æ•°æ®è·å–é€»è¾‘ã€‚
        æ‰€æœ‰æ—¥æœŸè¿‡æ»¤å’Œç¼“å­˜ç®¡ç†éƒ½ç”±è£…é¥°å™¨è‡ªåŠ¨å¤„ç†ã€‚

        Args:
            self: æŸ¥è¯¢å™¨å®ä¾‹ï¼Œå¿…é¡»å®ç° _query_raw æ–¹æ³•
            symbol (str): è‚¡ç¥¨ä»£ç ï¼Œæ ¼å¼å› å¸‚åœºè€Œå¼‚ï¼š
                - Aè‚¡: "SH600519", "SZ000001"
                - æ¸¯è‚¡: "00700", "09988"
                - ç¾è‚¡: "AAPL", "MSFT"
            start_date (Optional[str]): å¼€å§‹æ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼
                - ç”¨äºè¿‡æ»¤è¿”å›æ•°æ®çš„èµ·å§‹æ—¶é—´
                - å¦‚æœä¸ºNoneï¼Œä»æœ€æ—©çš„æ•°æ®å¼€å§‹
            end_date (Optional[str]): ç»“æŸæ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼
                - ç”¨äºè¿‡æ»¤è¿”å›æ•°æ®çš„ç»“æŸæ—¶é—´
                - å¦‚æœä¸ºNoneï¼Œåˆ°æœ€æ–°çš„æ•°æ®ä¸ºæ­¢

        Returns:
            pd.DataFrame: åŒ…å«è´¢åŠ¡æ•°æ®çš„DataFrameï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š
                - åŒ…å«æŒ‡å®šçš„æ—¥æœŸå­—æ®µ
                - æ•°æ®å·²æŒ‰æ—¥æœŸè¿‡æ»¤
                - æ ¼å¼æ ‡å‡†åŒ–ï¼Œä¾¿äºåç»­å¤„ç†

        Raises:
            NotImplementedError: å¦‚æœå­ç±»æœªå®ç° _query_raw æ–¹æ³•
            Exception: æ•°æ®è·å–è¿‡ç¨‹ä¸­çš„å…¶ä»–å¼‚å¸¸

        Note:
            è¯¥æ–¹æ³•æœ¬èº«ä¸åŒ…å«å…·ä½“çš„æŸ¥è¯¢é€»è¾‘ï¼Œè€Œæ˜¯å§”æ‰˜ç»™å­ç±»çš„ _query_raw æ–¹æ³•ã€‚
            ç¼“å­˜è£…é¥°å™¨ä¼šæ™ºèƒ½å¤„ç†å¢é‡æ›´æ–°å’Œç¼“å­˜ç®¡ç†ã€‚
        """
        # ç›´æ¥è·å–åŸå§‹æ•°æ®ï¼Œæ—¥æœŸè¿‡æ»¤ç”±ç¼“å­˜å±‚è‡ªåŠ¨å¤„ç†
        # è¿™ç§è®¾è®¡ç¡®ä¿äº†ç¼“å­˜é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘çš„åˆ†ç¦»
        return self._query_raw(symbol, start_date, end_date)

    return cached_query


class BaseDataQueryer(IDataQueryer):
    """
    æ•°æ®æŸ¥è¯¢å™¨åŸºç±» - SQLiteæ™ºèƒ½ç¼“å­˜æ¶æ„æ ¸å¿ƒ

    è¯¥æŠ½è±¡åŸºç±»å®šä¹‰äº†æ‰€æœ‰å¸‚åœºæŸ¥è¯¢å™¨çš„ç»Ÿä¸€æ¥å£å’Œæ ¸å¿ƒåŠŸèƒ½ã€‚
    é›†æˆSQLiteæ™ºèƒ½ç¼“å­˜ç³»ç»Ÿï¼Œæä¾›é«˜æ•ˆçš„æ•°æ®æŸ¥è¯¢å’Œç¼“å­˜ç®¡ç†èƒ½åŠ›ã€‚

    é‡‡ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå®šä¹‰äº†æŸ¥è¯¢çš„æ ‡å‡†æµç¨‹ï¼Œå­ç±»åªéœ€å®ç°å…·ä½“çš„æ•°æ®è·å–é€»è¾‘ã€‚

    ## ğŸ¯ æ ¸å¿ƒèŒè´£

    ### ç¼“å­˜ç®¡ç†
    - è‡ªåŠ¨é›†æˆSQLiteæ™ºèƒ½ç¼“å­˜è£…é¥°å™¨
    - æ”¯æŒå¢é‡æ›´æ–°ï¼Œå‡å°‘APIè°ƒç”¨
    - æä¾›çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®èƒ½åŠ›

    ### æ¥å£æ ‡å‡†åŒ–
    - ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£è®¾è®¡
    - æ ‡å‡†åŒ–çš„å‚æ•°ä¼ é€’å’Œè¿”å›æ ¼å¼
    - ä¸€è‡´çš„é”™è¯¯å¤„ç†æœºåˆ¶

    ### é…ç½®ç®¡ç†
    - å¯é…ç½®çš„ç¼“å­˜å‚æ•°
    - çµæ´»çš„æ—¥æœŸå­—æ®µæ˜ å°„
    - æ”¯æŒä¸åŒå¸‚åœºçš„ç‰¹æ®Šéœ€æ±‚

    ## ğŸ”§ å­ç±»å®ç°è¦æ±‚

    ### å¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•
    - `_query_raw()`: å…·ä½“çš„æ•°æ®è·å–é€»è¾‘

    ### å¯é…ç½®çš„ç±»å±æ€§
    - `cache_date_field`: æ—¥æœŸå­—æ®µå
    - `cache_query_type`: æŸ¥è¯¢ç±»å‹æ ‡è¯†

    ## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

    ```python
    class MyStockQueryer(BaseDataQueryer):
        cache_date_field = 'report_date'
        cache_query_type = 'my_stock_data'

        def _query_raw(self, symbol, start_date=None, end_date=None):
            # å®ç°å…·ä½“çš„æ•°æ®è·å–é€»è¾‘
            return get_stock_data(symbol, start_date, end_date)

    # ä½¿ç”¨
    queryer = MyStockQueryer()
    data = queryer.query("AAPL", "2023-01-01", "2023-12-31")
    ```

    Attributes:
        cache_date_field (ClassVar[str]): æ—¥æœŸå­—æ®µåï¼Œç”¨äºç¼“å­˜ç´¢å¼•
        cache_query_type (ClassVar[str]): æŸ¥è¯¢ç±»å‹æ ‡è¯†ï¼Œç”¨äºç¼“å­˜åˆ†ç±»
        _query_with_dates (callable): å¸¦ç¼“å­˜è£…é¥°å™¨çš„æŸ¥è¯¢æ–¹æ³•å®ä¾‹

    Note:
        è¯¥ç±»æ˜¯æŠ½è±¡åŸºç±»ï¼Œä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ä½¿ç”¨ã€‚
        å­ç±»å¿…é¡»å®ç° _query_raw æ–¹æ³•æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚
    """

    # å­ç±»å¯é…ç½®çš„ç¼“å­˜å‚æ•°
    cache_date_field: ClassVar[str] = 'date'  # é»˜è®¤æ—¥æœŸå­—æ®µå
    cache_query_type: ClassVar[str] = 'indicators'  # é»˜è®¤æŸ¥è¯¢ç±»å‹æ ‡è¯†

    def __init__(self, stock_identifier: Optional[StockIdentifier] = None):
        """
        åˆå§‹åŒ–æŸ¥è¯¢å™¨å®ä¾‹

        åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨ä¾èµ–æ³¨å…¥çš„è‚¡ç¥¨ä»£ç è¯†åˆ«å™¨å’Œå¸¦ç¼“å­˜è£…é¥°å™¨çš„æŸ¥è¯¢æ–¹æ³•ï¼Œ
        å¹¶å°†å…¶ç»‘å®šåˆ°å½“å‰å®ä¾‹ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†æ¯ä¸ªå®ä¾‹éƒ½æœ‰ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ï¼Œ
        åŒæ—¶ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ã€‚

        Args:
            stock_identifier (Optional[StockIdentifier]): è‚¡ç¥¨ä»£ç è¯†åˆ«å™¨å®ä¾‹
                - å¦‚æœä¸ºNoneï¼Œå°†åˆ›å»ºé»˜è®¤çš„StockIdentifierå®ä¾‹
                - æ”¯æŒæ³¨å…¥è‡ªå®šä¹‰çš„è¯†åˆ«å™¨å®ç°ï¼Œä¾¿äºæµ‹è¯•å’Œæ‰©å±•

        Raises:
            TypeError: å¦‚æœå­ç±»æœªæ­£ç¡®é…ç½®ç¼“å­˜å‚æ•°

        Note:
            åˆå§‹åŒ–è¿‡ç¨‹ä¸»è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š
            1. è·å–è‚¡ç¥¨ä»£ç è¯†åˆ«å™¨å®ä¾‹ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
            2. è¯»å–å­ç±»çš„ç¼“å­˜é…ç½®å‚æ•°
            3. è°ƒç”¨å·¥å‚å‡½æ•°åˆ›å»ºç¼“å­˜æŸ¥è¯¢æ–¹æ³•
            4. å°†æ–¹æ³•ç»‘å®šåˆ°å½“å‰å®ä¾‹

        Example:
            # ä½¿ç”¨é»˜è®¤è¯†åˆ«å™¨
            queryer = AStockIndicatorQueryer()

            # ä½¿ç”¨è‡ªå®šä¹‰è¯†åˆ«å™¨ï¼ˆæµ‹è¯•åœºæ™¯ï¼‰
            mock_identifier = MockStockIdentifier()
            queryer = AStockIndicatorQueryer(stock_identifier=mock_identifier)
        """
        try:
            # ä¾èµ–æ³¨å…¥ï¼šä½¿ç”¨ä¼ å…¥çš„è‚¡ç¥¨ä»£ç è¯†åˆ«å™¨ï¼Œå¦‚æœæœªä¼ å…¥åˆ™åˆ›å»ºé»˜è®¤å®ä¾‹
            self._stock_identifier = stock_identifier or StockIdentifier()

            # ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºå¸¦ç¼“å­˜è£…é¥°å™¨çš„æŸ¥è¯¢æ–¹æ³•
            # ä¼ å…¥å­ç±»é…ç½®çš„ç¼“å­˜å‚æ•°
            cached_method = create_cached_query_method(
                cache_date_field=self.cache_date_field,
                cache_query_type=self.cache_query_type
            )

            # å°†æ–¹æ³•ç»‘å®šåˆ°å½“å‰å®ä¾‹ï¼Œä½¿å…¶æˆä¸ºå®ä¾‹æ–¹æ³•
            # __get__ æ˜¯Pythonçš„æè¿°ç¬¦åè®®æ–¹æ³•
            self._query_with_dates = cached_method.__get__(self, type(self))

        except Exception as e:
            raise TypeError(f"åˆå§‹åŒ–æŸ¥è¯¢å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¼“å­˜é…ç½®: {e}")

    def _format_symbol_for_api(self, symbol: str) -> str:
        """
        æ ¹æ®æŸ¥è¯¢å™¨ç±»å‹æ ¼å¼åŒ–è‚¡ç¥¨ä»£ç ä¸ºAPIå…¼å®¹æ ¼å¼

        è¯¥æ–¹æ³•ä½¿ç”¨ StockIdentifier è¯†åˆ«è‚¡ç¥¨ä»£ç çš„å¸‚åœºç±»å‹ï¼Œç„¶åè½¬æ¢ä¸ºå„å¸‚åœºAPI
        æ‰€éœ€çš„æ ¼å¼ã€‚ä¸»è¦è§£å†³ A è‚¡ä»£ç éœ€è¦äº¤æ˜“æ‰€å‰ç¼€çš„é—®é¢˜ã€‚

        Args:
            symbol (str): è¾“å…¥çš„è‚¡ç¥¨ä»£ç ï¼Œå¯ä»¥æ˜¯ä»»æ„æ ¼å¼

        Returns:
            str: æ ¼å¼åŒ–åçš„è‚¡ç¥¨ä»£ç ï¼Œç¬¦åˆå…·ä½“å¸‚åœºAPIè¦æ±‚

        Raises:
            ValueError: å½“è‚¡ç¥¨ä»£ç æ ¼å¼æ— æ³•è¯†åˆ«æˆ–è½¬æ¢å¤±è´¥æ—¶

        Note:
            æ ¼å¼è½¬æ¢è§„åˆ™ï¼š
            - Aè‚¡ï¼š6ä½æ•°å­— â†’ SH/SZå‰ç¼€ + 6ä½æ•°å­— (å¦‚ï¼š600519 â†’ SH600519)
            - æ¸¯è‚¡ï¼šä¿æŒ5ä½æ•°å­—æ ¼å¼ (å¦‚ï¼š00700)
            - ç¾è‚¡ï¼šä¿æŒå¤§å†™å­—æ¯æ ¼å¼ (å¦‚ï¼šAAPL)
        """
        try:
            # è¾“å…¥éªŒè¯
            if not symbol or not isinstance(symbol, str):
                raise ValueError(f"è‚¡ç¥¨ä»£ç ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»ä¸ºå­—ç¬¦ä¸²ï¼š{symbol}")

            symbol = symbol.strip()
            if not symbol:
                raise ValueError("è‚¡ç¥¨ä»£ç ä¸èƒ½ä¸ºç©ºå­—ç¬¦ä¸²")

            # ç‰¹æ®Šå¤„ç†1ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯Aè‚¡äº¤æ˜“æ‰€å‰ç¼€æ ¼å¼
            if symbol.startswith(("SH", "SZ")) and len(symbol) == 8 and symbol[2:].isdigit():
                # å·²ç»æ˜¯æ­£ç¡®çš„Aè‚¡APIæ ¼å¼ï¼Œç›´æ¥è¿”å›
                return symbol

            # è¯†åˆ«å¸‚åœºç±»å‹å¹¶æ ‡å‡†åŒ–ä»£ç 
            market_type, standardized_symbol = self._identify_market_type(symbol)

            # æ ¹æ®å¸‚åœºç±»å‹è¿›è¡ŒAPIæ ¼å¼è½¬æ¢
            if market_type == MarketType.A_STOCK:
                # Aè‚¡éœ€è¦æ·»åŠ äº¤æ˜“æ‰€å‰ç¼€
                if len(standardized_symbol) == 6:
                    # ç®€å•åˆ¤æ–­ï¼š6å¼€å¤´ä¸ºä¸Šæµ·ï¼Œå…¶ä»–ä¸ºæ·±åœ³
                    if standardized_symbol.startswith('6'):
                        return f"SH{standardized_symbol}"
                    else:
                        return f"SZ{standardized_symbol}"
                else:
                    raise ValueError(f"Aè‚¡ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼š{symbol} (æ ‡å‡†åŒ–åï¼š{standardized_symbol})")

            elif market_type == MarketType.HK_STOCK:
                # æ¸¯è‚¡ä¿æŒ5ä½æ•°å­—æ ¼å¼ï¼Œä½¿ç”¨ StockIdentifier æ ¼å¼åŒ–
                formatted = self._stock_identifier.format_symbol(market_type, standardized_symbol)
                # éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯5ä½æ•°å­—ï¼‰
                if len(formatted) != 5 or not formatted.isdigit():
                    raise ValueError(f"æ¸¯è‚¡ä»£ç æ ¼å¼åŒ–å¤±è´¥ï¼š{symbol} â†’ {formatted} (æœŸæœ›5ä½æ•°å­—)")
                return formatted

            elif market_type == MarketType.US_STOCK:
                # ç¾è‚¡ä¿æŒå¤§å†™å­—æ¯æ ¼å¼ï¼Œä½¿ç”¨ StockIdentifier æ ¼å¼åŒ–
                formatted = self._stock_identifier.format_symbol(market_type, standardized_symbol)
                # éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯1-5ä½å¤§å†™å­—æ¯ï¼‰
                if not (1 <= len(formatted) <= 5) or not formatted.isalpha() or not formatted.isupper():
                    raise ValueError(f"ç¾è‚¡ä»£ç æ ¼å¼åŒ–å¤±è´¥ï¼š{symbol} â†’ {formatted} (æœŸæœ›1-5ä½å¤§å†™å­—æ¯)")
                return formatted

            else:
                raise ValueError(f"ä¸æ”¯æŒçš„å¸‚åœºç±»å‹ï¼š{market_type}")

        except Exception as e:
            raise ValueError(f"è‚¡ç¥¨ä»£ç æ ¼å¼è½¬æ¢å¤±è´¥ï¼š{symbol}ï¼Œé”™è¯¯ï¼š{e}")

    def _identify_market_type(self, symbol: str) -> Tuple[MarketType, str]:
        """
        è¯†åˆ«è‚¡ç¥¨ä»£ç å¸‚åœºç±»å‹å¹¶æ ‡å‡†åŒ–ï¼Œæ”¹è¿› StockIdentifier çš„é€»è¾‘

        Args:
            symbol: è‚¡ç¥¨ä»£ç 

        Returns:
            (å¸‚åœºç±»å‹, æ ‡å‡†åŒ–åçš„è‚¡ç¥¨ä»£ç )
        """
        # ç‰¹æ®Šå¤„ç†ï¼šæ•°å­—è‚¡ç¥¨ä»£ç æ ¼å¼ï¼Œæ”¹è¿› StockIdentifier çš„é€»è¾‘
        if symbol.isdigit():
            if len(symbol) == 6:
                # Aè‚¡ï¼š6ä½æ•°å­—
                return MarketType.A_STOCK, symbol
            elif len(symbol) <= 5:
                # æ¸¯è‚¡ï¼š1-5ä½æ•°å­—ï¼Œä½¿ç”¨ StockIdentifier æ ¼å¼åŒ–
                return MarketType.HK_STOCK, symbol
            else:
                raise ValueError(f"æ— æ³•è¯†åˆ«çš„æ•°å­—è‚¡ç¥¨ä»£ç ï¼š{symbol}")
        else:
            # ä½¿ç”¨ StockIdentifier è¯†åˆ«å…¶ä»–æ ¼å¼
            try:
                return self._stock_identifier.identify(symbol)
            except Exception:
                # å¦‚æœ StockIdentifier ä¹Ÿæ— æ³•è¯†åˆ«ï¼Œé»˜è®¤ä¸ºç¾è‚¡
                return MarketType.US_STOCK, symbol.upper()

    def query(self, symbol: str, start_date: Optional[str] = None,
              end_date: Optional[str] = None) -> pd.DataFrame:
        """
        æŸ¥è¯¢æ•°æ® - ç»Ÿä¸€çš„å¤–éƒ¨æ¥å£

        è¯¥æ–¹æ³•æä¾›äº†ç»Ÿä¸€çš„æ•°æ®æŸ¥è¯¢æ¥å£ï¼Œé›†æˆäº†è‚¡ç¥¨ä»£ç æ ¼å¼åŒ–ã€æ—¥æœŸè¿‡æ»¤ã€
        ç¼“å­˜ç®¡ç†å’Œé”™è¯¯å¤„ç†ã€‚è¿™æ˜¯ç”¨æˆ·è°ƒç”¨çš„ä¸»è¦å…¥å£ç‚¹ï¼Œæ‰€æœ‰å¤æ‚çš„é€»è¾‘éƒ½è¢«å°è£…åœ¨å†…éƒ¨ã€‚

        Args:
            symbol (str): è‚¡ç¥¨ä»£ç ï¼Œæ”¯æŒä»»æ„æ ¼å¼è¾“å…¥ï¼š
                - Aè‚¡: å¯æ¥å— "600519"ã€"SH600519" ç­‰æ ¼å¼ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºAPIè¦æ±‚æ ¼å¼
                - æ¸¯è‚¡: å¯æ¥å— "0700"ã€"00700" ç­‰æ ¼å¼ï¼Œè‡ªåŠ¨æ ‡å‡†åŒ–ä¸º5ä½æ•°å­—
                - ç¾è‚¡: å¯æ¥å— "aapl"ã€"AAPL" ç­‰æ ¼å¼ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™
            start_date (Optional[str]): å¼€å§‹æ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼ï¼š
                - ç”¨äºæŒ‡å®šæŸ¥è¯¢çš„æ—¶é—´èŒƒå›´èµ·å§‹ç‚¹
                - å¦‚æœä¸ºNoneï¼Œä»å¯è·å¾—çš„æœ€æ—©æ•°æ®å¼€å§‹
                - æ—¥æœŸæ ¼å¼å¿…é¡»ä¸¥æ ¼éµå¾ªYYYY-MM-DD
            end_date (Optional[str]): ç»“æŸæ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼ï¼š
                - ç”¨äºæŒ‡å®šæŸ¥è¯¢çš„æ—¶é—´èŒƒå›´ç»“æŸç‚¹
                - å¦‚æœä¸ºNoneï¼Œåˆ°å¯è·å¾—çš„æœ€æ–°æ•°æ®ä¸ºæ­¢
                - æ—¥æœŸæ ¼å¼å¿…é¡»ä¸¥æ ¼éµå¾ªYYYY-MM-DD

        Returns:
            pd.DataFrame: åŒ…å«è´¢åŠ¡æ•°æ®çš„DataFrameï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š
                - åŒ…å«å®Œæ•´çš„æ—¥æœŸèŒƒå›´æ•°æ®
                - æ•°æ®å·²æŒ‰æ—¥æœŸæ’åºï¼ˆé€šå¸¸ä¸ºé™åºï¼‰
                - åŒ…å«ç¼“å­˜ç³»ç»Ÿç®¡ç†çš„å…ƒæ•°æ®å­—æ®µ
                - æ ¼å¼æ ‡å‡†åŒ–ï¼Œä¾¿äºåç»­åˆ†æå’Œå¤„ç†

        Raises:
            ValueError: å½“è‚¡ç¥¨ä»£ç æ ¼å¼æ— æ³•è¯†åˆ«æˆ–è½¬æ¢å¤±è´¥æ—¶
            ValueError: å½“æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®æ—¶
            Exception: å½“APIè°ƒç”¨å¤±è´¥æˆ–æ•°æ®è·å–å¼‚å¸¸æ—¶

        Example:
            >>> queryer = AStockIndicatorQueryer()
            >>> # æŸ¥è¯¢è´µå·èŒ…å°2023å¹´å…¨å¹´è´¢åŠ¡æŒ‡æ ‡ï¼Œæ”¯æŒå¤šç§è¾“å…¥æ ¼å¼
            >>> data1 = queryer.query("600519", "2023-01-01", "2023-12-31")  # è‡ªåŠ¨è½¬æ¢ä¸ºSH600519
            >>> data2 = queryer.query("SH600519", "2023-01-01", "2023-12-31")  # ç›´æ¥ä½¿ç”¨
            >>> print(f"è·å–åˆ° {len(data1)} æ¡è´¢åŠ¡è®°å½•")

            >>> # æŸ¥è¯¢æ‰€æœ‰å†å²æ•°æ®
            >>> all_data = queryer.query("600519")

        Note:
            - è‚¡ç¥¨ä»£ç æ ¼å¼è½¬æ¢ï¼šè‡ªåŠ¨è¯†åˆ«å¸‚åœºç±»å‹å¹¶è½¬æ¢ä¸ºAPIå…¼å®¹æ ¼å¼
            - ç¼“å­˜é€»è¾‘ï¼šé¦–æ¬¡æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢ï¼ˆéœ€è¦APIè°ƒç”¨ï¼‰ï¼Œåç»­æŸ¥è¯¢æ˜¾è‘—åŠ é€Ÿ
            - å¢é‡æ›´æ–°ï¼šç¼“å­˜å±‚æ”¯æŒå¢é‡æ›´æ–°ï¼Œåªä¼šè·å–ç¼ºå¤±çš„æ—¶é—´æ®µæ•°æ®
            - é”™è¯¯å¤„ç†ï¼šä»£ç æ ¼å¼è½¬æ¢å¤±è´¥æ—¶ä¼šæŠ›å‡ºè¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯
            - é€æ˜å¤„ç†ï¼šæ‰€æœ‰æ—¥æœŸå¤„ç†å’Œè¿‡æ»¤éƒ½æ˜¯é€æ˜çš„ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒå…·ä½“å®ç°
        """
        # ä½¿ç”¨ StockIdentifier æ ¼å¼åŒ–è‚¡ç¥¨ä»£ç ä¸ºAPIå…¼å®¹æ ¼å¼
        formatted_symbol = self._format_symbol_for_api(symbol)

        # è°ƒç”¨å¸¦ç¼“å­˜çš„æŸ¥è¯¢æ–¹æ³•
        return self._query_with_dates(formatted_symbol, start_date, end_date)

    def _query_raw(self, symbol: str, start_date: Optional[str] = None,
                   end_date: Optional[str] = None) -> pd.DataFrame:
        """
        è·å–åŸå§‹è´¢åŠ¡æ•°æ® - æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»å®ç°

        è¯¥æ–¹æ³•å®šä¹‰äº†æ•°æ®è·å–çš„æŠ½è±¡æ¥å£ï¼Œå­ç±»å¿…é¡»æ ¹æ®å…·ä½“çš„å¸‚åœºå’ŒAPI
        å®ç°ç›¸åº”çš„æ•°æ®è·å–é€»è¾‘ã€‚

        ## ğŸ¯ æ–¹æ³•èŒè´£

        ### æ•°æ®è·å–
        - è°ƒç”¨ç›¸åº”çš„APIè·å–åŸå§‹è´¢åŠ¡æ•°æ®
        - å¤„ç†APIçš„ç‰¹æ®Šå‚æ•°å’Œè¿”å›æ ¼å¼
        - è¿›è¡ŒåŸºæœ¬çš„æ•°æ®éªŒè¯å’Œæ¸…ç†

        ### æ•°æ®æ ¼å¼åŒ–
        - ç¡®ä¿è¿”å›æ ‡å‡†çš„pandas.DataFrameæ ¼å¼
        - åŒ…å«å¿…è¦çš„æ—¥æœŸå­—æ®µå’Œæ•°æ®å­—æ®µ
        - å¤„ç†æ•°æ®ç±»å‹è½¬æ¢å’Œæ ¼å¼æ ‡å‡†åŒ–

        ## ğŸ”§ å®ç°è¦æ±‚

        ### å‚æ•°å¤„ç†
        - å¿…é¡»æ¥å—symbolã€start_dateã€end_dateå‚æ•°
        - æ ¹æ®å…·ä½“APIçš„æ”¯æŒæƒ…å†µå¤„ç†æ—¥æœŸå‚æ•°
        - è¿›è¡Œå‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

        ### è¿”å›æ ¼å¼
        - å¿…é¡»è¿”å›pandas.DataFrameå¯¹è±¡
        - åŒ…å«cache_date_fieldæŒ‡å®šçš„æ—¥æœŸå­—æ®µ
        - æ•°æ®å­—æ®µåç§°å’Œæ ¼å¼è¦ä¿æŒä¸€è‡´

        Args:
            symbol (str): è‚¡ç¥¨ä»£ç ï¼Œå­ç±»éœ€è¦éªŒè¯æ ¼å¼çš„æ­£ç¡®æ€§
            start_date (Optional[str]): å¼€å§‹æ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼
                - æŸäº›APIå¯èƒ½ä¸æ”¯æŒæ—¥æœŸå‚æ•°
                - å­ç±»éœ€è¦æ ¹æ®APIèƒ½åŠ›å¤„ç†è¯¥å‚æ•°
            end_date (Optional[str]): ç»“æŸæ—¥æœŸï¼ŒYYYY-MM-DDæ ¼å¼
                - æŸäº›APIå¯èƒ½ä¸æ”¯æŒæ—¥æœŸå‚æ•°
                - å­ç±»éœ€è¦æ ¹æ®APIèƒ½åŠ›å¤„ç†è¯¥å‚æ•°

        Returns:
            pd.DataFrame: åŒ…å«åŸå§‹è´¢åŠ¡æ•°æ®çš„DataFrameï¼Œè¦æ±‚ï¼š
                - åŒ…å«é…ç½®çš„æ—¥æœŸå­—æ®µï¼ˆcache_date_fieldï¼‰
                - æ•°æ®ç±»å‹æ­£ç¡®ï¼Œæ—¥æœŸå­—æ®µä¸ºdatetimeç±»å‹
                - æ ¼å¼æ ‡å‡†åŒ–ï¼Œä¾¿äºç¼“å­˜ç³»ç»Ÿå¤„ç†
                - ä¸åŒ…å«æ—¥æœŸè¿‡æ»¤ï¼ˆç”±ç¼“å­˜å±‚å¤„ç†ï¼‰

        Raises:
            NotImplementedError: å­ç±»æœªå®ç°è¯¥æ–¹æ³•æ—¶çš„é»˜è®¤å¼‚å¸¸
            ValueError: è‚¡ç¥¨ä»£ç æ ¼å¼ä¸æ­£ç¡®
            Exception: APIè°ƒç”¨å¤±è´¥æˆ–æ•°æ®è·å–å¼‚å¸¸

        Example:
            >>> class MyQueryer(BaseDataQueryer):
            ...     def _query_raw(self, symbol, start_date=None, end_date=None):
            ...         # è°ƒç”¨å…·ä½“çš„API
            ...         raw_data = some_api.get_data(symbol, start_date, end_date)
            ...         # æ•°æ®å¤„ç†å’Œæ ¼å¼åŒ–
            ...         return process_data(raw_data)

        Note:
            - è¯¥æ–¹æ³•åº”è¯¥ä¸“æ³¨äºæ•°æ®è·å–ï¼Œä¸è¿›è¡Œç¼“å­˜å¤„ç†
            - æ—¥æœŸè¿‡æ»¤ç”±ä¸Šå±‚çš„ç¼“å­˜è£…é¥°å™¨è‡ªåŠ¨å¤„ç†
            - å­ç±»åº”è¯¥æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
            - å»ºè®®åœ¨æ–¹æ³•æ–‡æ¡£ä¸­è¯´æ˜å…·ä½“çš„APIé™åˆ¶å’Œç‰¹æ€§
        """
        raise NotImplementedError("å­ç±»å¿…é¡»å®ç° _query_raw æ–¹æ³•ä»¥æä¾›å…·ä½“çš„æ•°æ®è·å–é€»è¾‘")

  